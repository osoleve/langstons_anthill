{"version":3,"file":"index-CRsiirhG.js","sources":["../../src/sse/client.ts","../../src/renderer/canvas.ts","../../src/renderer/particles.ts","../../src/renderer/tiles.ts","../../src/renderer/entities.ts","../../src/renderer/spirits.ts","../../src/ui/panels.ts","../../src/ui/tooltip.ts","../../src/ui/modal.ts","../../src/main.ts"],"sourcesContent":["import type { GameState } from '../types/state.ts'\r\n\r\nexport type StateHandler = (state: GameState) => void\r\n\r\nexport class SSEClient {\r\n  private eventSource: EventSource | null = null\r\n  private handlers: Set<StateHandler> = new Set()\r\n  private lastState: GameState | null = null\r\n\r\n  constructor(private url: string = '/events') {}\r\n\r\n  connect(): void {\r\n    this.eventSource = new EventSource(this.url)\r\n\r\n    this.eventSource.onmessage = (event) => {\r\n      try {\r\n        const state = JSON.parse(event.data) as GameState\r\n        this.lastState = state\r\n        this.handlers.forEach(handler => handler(state))\r\n      } catch (e) {\r\n        console.error('Failed to parse state:', e)\r\n      }\r\n    }\r\n\r\n    this.eventSource.onerror = () => {\r\n      console.error('SSE connection error, reconnecting...')\r\n      this.reconnect()\r\n    }\r\n  }\r\n\r\n  private reconnect(): void {\r\n    this.disconnect()\r\n    setTimeout(() => this.connect(), 2000)\r\n  }\r\n\r\n  disconnect(): void {\r\n    if (this.eventSource) {\r\n      this.eventSource.close()\r\n      this.eventSource = null\r\n    }\r\n  }\r\n\r\n  onState(handler: StateHandler): () => void {\r\n    this.handlers.add(handler)\r\n    // If we already have state, call handler immediately\r\n    if (this.lastState) {\r\n      handler(this.lastState)\r\n    }\r\n    return () => this.handlers.delete(handler)\r\n  }\r\n\r\n  getLastState(): GameState | null {\r\n    return this.lastState\r\n  }\r\n}\r\n\r\n// Fetch initial state\r\nexport async function fetchInitialState(): Promise<GameState | null> {\r\n  try {\r\n    const response = await fetch('/state')\r\n    return await response.json() as GameState\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n","export interface CanvasContext {\r\n  canvas: HTMLCanvasElement\r\n  ctx: CanvasRenderingContext2D\r\n  width: number\r\n  height: number\r\n}\r\n\r\nexport function setupCanvas(container: HTMLElement): CanvasContext {\r\n  const canvas = document.createElement('canvas')\r\n  canvas.style.position = 'absolute'\r\n  canvas.style.top = '0'\r\n  canvas.style.left = '0'\r\n  canvas.style.pointerEvents = 'none'\r\n  container.appendChild(canvas)\r\n\r\n  const ctx = canvas.getContext('2d')!\r\n\r\n  function resize() {\r\n    canvas.width = container.clientWidth\r\n    canvas.height = container.clientHeight\r\n  }\r\n\r\n  resize()\r\n  window.addEventListener('resize', resize)\r\n\r\n  return {\r\n    canvas,\r\n    ctx,\r\n    get width() { return canvas.width },\r\n    get height() { return canvas.height }\r\n  }\r\n}\r\n\r\nexport function clearCanvas(context: CanvasContext): void {\r\n  context.ctx.clearRect(0, 0, context.width, context.height)\r\n}\r\n","import type { GameState, Tile, System } from '../types/state.ts'\r\nimport { getTileCenter } from './tiles.ts'\r\n\r\ninterface Particle {\r\n  x: number\r\n  y: number\r\n  targetX: number\r\n  targetY: number\r\n  progress: number\r\n  speed: number\r\n  color: string\r\n  size: number\r\n  resource: string\r\n  stalled: boolean\r\n}\r\n\r\n// Resource color palette - extensible for new resource types\r\nconst RESOURCE_COLORS: Record<string, string> = {\r\n  dirt: '#8b7355',\r\n  nutrients: '#5a8a5a',\r\n  fungus: '#7a6a9a',\r\n  crystals: '#aaccff',\r\n  ore: '#c9a959',\r\n  influence: '#aa88ff',\r\n  insight: '#88ffaa',\r\n  strange_matter: '#ff88aa',\r\n}\r\n\r\nfunction getResourceColor(resource: string): string {\r\n  return RESOURCE_COLORS[resource] ?? '#888888'\r\n}\r\n\r\nconst particles: Particle[] = []\r\n\r\n// Track which flows are stalled (no resources to consume)\r\nconst stalledFlows: Set<string> = new Set()\r\n\r\nexport function getStalledFlows(): Set<string> {\r\n  return stalledFlows\r\n}\r\n\r\nfunction spawnParticle(\r\n  from: { x: number; y: number },\r\n  to: { x: number; y: number },\r\n  resource: string,\r\n  stalled: boolean = false\r\n): void {\r\n  particles.push({\r\n    x: from.x,\r\n    y: from.y,\r\n    targetX: to.x,\r\n    targetY: to.y,\r\n    progress: 0,\r\n    speed: 0.01 + Math.random() * 0.01,\r\n    color: getResourceColor(resource),\r\n    size: 2 + Math.random() * 2,\r\n    resource,\r\n    stalled\r\n  })\r\n}\r\n\r\nexport function updateParticles(): void {\r\n  for (let i = particles.length - 1; i >= 0; i--) {\r\n    const p = particles[i]\r\n    p.progress += p.speed\r\n    p.x += (p.targetX - p.x) * p.speed * 2\r\n    p.y += (p.targetY - p.y) * p.speed * 2\r\n\r\n    if (p.progress >= 1) {\r\n      particles.splice(i, 1)\r\n    }\r\n  }\r\n}\r\n\r\n// Find tile that hosts a given system\r\nfunction findSystemTile(systemId: string, tiles: Record<string, Tile>): string | null {\r\n  // Direct match: system ID matches tile ID\r\n  if (tiles[systemId]) return systemId\r\n\r\n  // Common patterns: system \"foo_bar\" might be on tile \"foo_bar_tile\"\r\n  const withTileSuffix = `${systemId}_tile`\r\n  if (tiles[withTileSuffix]) return withTileSuffix\r\n\r\n  // Check for partial matches (e.g., \"dig_site\" system on \"dig_site\" tile)\r\n  for (const tileId of Object.keys(tiles)) {\r\n    if (tileId.includes(systemId) || systemId.includes(tileId)) {\r\n      return tileId\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n// Find connected tile that could be a consumer/producer destination\r\nfunction findConnectedTile(\r\n  fromTileId: string,\r\n  connections: [string, string][],\r\n  tiles: Record<string, Tile>,\r\n  preferOrigin: boolean = true\r\n): string | null {\r\n  // Find all connections involving this tile\r\n  const connected: string[] = []\r\n  for (const [a, b] of connections) {\r\n    if (a === fromTileId) connected.push(b)\r\n    if (b === fromTileId) connected.push(a)\r\n  }\r\n\r\n  // Prefer origin as central hub\r\n  if (preferOrigin && connected.includes('origin')) return 'origin'\r\n\r\n  return connected[0] ?? null\r\n}\r\n\r\nexport function spawnResourceParticles(state: GameState): void {\r\n  const tiles = state.map?.tiles\r\n  const systems = state.systems\r\n  const connections = state.map?.connections\r\n  const resources = state.resources ?? {}\r\n\r\n  if (!tiles || !systems || !connections) return\r\n\r\n  stalledFlows.clear()\r\n\r\n  // Iterate over all systems and spawn particles based on their generates/consumes\r\n  for (const [systemId, system] of Object.entries(systems)) {\r\n    const sourceTileId = findSystemTile(systemId, tiles)\r\n    if (!sourceTileId) continue\r\n\r\n    const sourcePos = getTileCenter(sourceTileId, tiles)\r\n    if (!sourcePos) continue\r\n\r\n    // Systems that GENERATE resources: particles flow FROM this tile\r\n    if (system.generates) {\r\n      for (const [resource, rate] of Object.entries(system.generates)) {\r\n        if (rate <= 0) continue\r\n\r\n        // Spawn probability proportional to generation rate\r\n        // Base: 0.01/tick = 5% spawn chance, 0.1/tick = 50% spawn chance\r\n        const spawnChance = Math.min(0.5, rate * 5)\r\n\r\n        if (Math.random() < spawnChance) {\r\n          // Find destination - prefer origin as central resource hub\r\n          const destTileId = findConnectedTile(sourceTileId, connections, tiles, true)\r\n          if (destTileId) {\r\n            const destPos = getTileCenter(destTileId, tiles)\r\n            if (destPos) {\r\n              spawnParticle(sourcePos, destPos, resource)\r\n            }\r\n          } else {\r\n            // No connection - particles rise up and dissipate (resource accumulating locally)\r\n            spawnParticle(\r\n              sourcePos,\r\n              { x: sourcePos.x, y: sourcePos.y - 40 },\r\n              resource\r\n            )\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Systems that CONSUME resources: particles flow TO this tile\r\n    if (system.consumes) {\r\n      for (const [resource, rate] of Object.entries(system.consumes)) {\r\n        if (rate <= 0) continue\r\n\r\n        const currentAmount = resources[resource] ?? 0\r\n        const isStalled = currentAmount < rate * 10 // Low on this resource\r\n\r\n        if (isStalled) {\r\n          stalledFlows.add(`${systemId}:${resource}`)\r\n        }\r\n\r\n        const spawnChance = Math.min(0.3, rate * 3)\r\n\r\n        if (Math.random() < spawnChance) {\r\n          // Find source - prefer origin as central resource hub\r\n          const srcTileId = findConnectedTile(sourceTileId, connections, tiles, true)\r\n          if (srcTileId) {\r\n            const srcPos = getTileCenter(srcTileId, tiles)\r\n            if (srcPos) {\r\n              spawnParticle(srcPos, sourcePos, resource, isStalled)\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Special: Observer entities generate insight particles\r\n  const hasObserver = state.entities?.some(e => e.subtype === 'observer')\r\n  if (hasObserver && Math.random() < 0.1) {\r\n    const receiverPos = getTileCenter('receiver', tiles)\r\n    if (receiverPos) {\r\n      spawnParticle(\r\n        { x: receiverPos.x + (Math.random() - 0.5) * 30, y: receiverPos.y + (Math.random() - 0.5) * 30 },\r\n        { x: receiverPos.x, y: receiverPos.y - 40 },\r\n        'insight'\r\n      )\r\n    }\r\n  }\r\n\r\n  // Special: Influence flowing to receiver when present\r\n  if ((resources.influence ?? 0) > 0.5 && Math.random() < 0.05) {\r\n    const originPos = getTileCenter('origin', tiles)\r\n    const receiverPos = getTileCenter('receiver', tiles)\r\n    if (originPos && receiverPos) {\r\n      spawnParticle(originPos, receiverPos, 'influence')\r\n    }\r\n  }\r\n}\r\n\r\nexport function drawParticles(ctx: CanvasRenderingContext2D): void {\r\n  for (const p of particles) {\r\n    ctx.beginPath()\r\n    const size = p.size * (1 - p.progress * 0.5)\r\n    ctx.arc(p.x, p.y, size, 0, Math.PI * 2)\r\n    ctx.fillStyle = p.color\r\n    ctx.globalAlpha = 1 - p.progress\r\n\r\n    if (p.stalled) {\r\n      // Stalled particles pulse and have a warning glow\r\n      const pulse = 0.5 + Math.sin(Date.now() / 200) * 0.3\r\n      ctx.globalAlpha *= pulse\r\n      ctx.shadowColor = '#ff4444'\r\n      ctx.shadowBlur = 8\r\n    }\r\n\r\n    ctx.fill()\r\n    ctx.shadowBlur = 0\r\n  }\r\n  ctx.globalAlpha = 1\r\n}\r\n","import type { GameState, Tile } from '../types/state.ts'\r\nimport { getStalledFlows } from './particles.ts'\r\n\r\nexport interface TilePosition {\r\n  x: number\r\n  y: number\r\n  centerX: number\r\n  centerY: number\r\n}\r\n\r\nconst TILE_SIZE = 100\r\nconst TILE_GAP = 20\r\nconst OFFSET_X = 250\r\nconst OFFSET_Y = 150\r\n\r\n// Store click handlers for cleanup\r\ntype TileClickHandler = (tileId: string, tile: Tile) => void\r\nlet currentClickHandler: TileClickHandler | null = null\r\n\r\nexport function setTileClickHandler(handler: TileClickHandler): void {\r\n  currentClickHandler = handler\r\n}\r\n\r\nexport function getTilePosition(tile: Tile): TilePosition {\r\n  const x = tile.x * (TILE_SIZE + TILE_GAP) + OFFSET_X\r\n  const y = tile.y * (TILE_SIZE + TILE_GAP) + OFFSET_Y\r\n  return {\r\n    x,\r\n    y,\r\n    centerX: x + TILE_SIZE / 2,\r\n    centerY: y + TILE_SIZE / 2\r\n  }\r\n}\r\n\r\nexport function getTileCenter(tileId: string, tiles: Record<string, Tile>): { x: number; y: number } | null {\r\n  const tile = tiles[tileId]\r\n  if (!tile) return null\r\n  const pos = getTilePosition(tile)\r\n  return { x: pos.centerX, y: pos.centerY }\r\n}\r\n\r\nexport function renderTiles(container: HTMLElement, state: GameState): void {\r\n  // Clear existing tiles\r\n  const existing = container.querySelector('.tiles-container')\r\n  if (existing) existing.remove()\r\n\r\n  const tilesContainer = document.createElement('div')\r\n  tilesContainer.className = 'tiles-container'\r\n  container.appendChild(tilesContainer)\r\n\r\n  const tiles = state.map?.tiles ?? {}\r\n  const systems = state.systems ?? {}\r\n  const entities = state.entities ?? []\r\n  const stalledFlows = getStalledFlows()\r\n\r\n  // Check which tiles have bottlenecks\r\n  const tilesWithBottlenecks = new Set<string>()\r\n  for (const flowKey of stalledFlows) {\r\n    const systemId = flowKey.split(':')[0]\r\n    // Find tile for this system\r\n    if (tiles[systemId]) {\r\n      tilesWithBottlenecks.add(systemId)\r\n    } else {\r\n      // Check for tile suffix pattern\r\n      const withSuffix = `${systemId}_tile`\r\n      if (tiles[withSuffix]) {\r\n        tilesWithBottlenecks.add(withSuffix)\r\n      }\r\n    }\r\n  }\r\n\r\n  for (const [id, tile] of Object.entries(tiles)) {\r\n    const div = document.createElement('div')\r\n    div.className = 'tile'\r\n    div.dataset.tileId = id\r\n\r\n    // System status\r\n    const system = systems[id]\r\n    if (system) {\r\n      div.classList.add('has-system')\r\n      if (system.generates && Object.keys(system.generates).length > 0) {\r\n        div.classList.add('generating')\r\n      }\r\n    }\r\n\r\n    // Bottleneck indicator\r\n    if (tilesWithBottlenecks.has(id)) {\r\n      div.classList.add('has-bottleneck')\r\n    }\r\n\r\n    // Blight\r\n    if (tile.blighted) {\r\n      div.classList.add('blighted')\r\n    }\r\n\r\n    // Antenna\r\n    if (tile.type === 'antenna') {\r\n      div.classList.add('antenna')\r\n      if ((state.resources?.influence ?? 0) > 0.5) {\r\n        div.classList.add('broadcasting')\r\n      }\r\n    }\r\n\r\n    const pos = getTilePosition(tile)\r\n    div.style.left = `${pos.x}px`\r\n    div.style.top = `${pos.y}px`\r\n\r\n    // Count entities\r\n    const antsHere = entities.filter(e => e.tile === id && e.type !== 'visitor').length\r\n    const visitorsHere = entities.filter(e => e.tile === id && e.type === 'visitor').length\r\n\r\n    let entityInfo = ''\r\n    if (antsHere > 0) {\r\n      entityInfo += `<div class=\"ant-count\">${antsHere} ant${antsHere > 1 ? 's' : ''}</div>`\r\n    }\r\n    if (visitorsHere > 0) {\r\n      entityInfo += `<div class=\"ant-count visitor-count\">${visitorsHere} visitor${visitorsHere > 1 ? 's' : ''}</div>`\r\n    }\r\n\r\n    div.innerHTML = `\r\n      <div class=\"tile-name\">${tile.name}</div>\r\n      <div class=\"tile-info\">${tile.type}</div>\r\n      ${entityInfo}\r\n    `\r\n\r\n    // Click handler\r\n    div.addEventListener('click', () => {\r\n      if (currentClickHandler) {\r\n        currentClickHandler(id, tile)\r\n      }\r\n    })\r\n\r\n    tilesContainer.appendChild(div)\r\n  }\r\n}\r\n\r\nexport function drawConnections(\r\n  ctx: CanvasRenderingContext2D,\r\n  state: GameState\r\n): void {\r\n  const tiles = state.map?.tiles\r\n  const connections = state.map?.connections\r\n  if (!tiles || !connections) return\r\n\r\n  ctx.strokeStyle = '#333'\r\n  ctx.lineWidth = 1\r\n  ctx.setLineDash([4, 4])\r\n\r\n  for (const [from, to] of connections) {\r\n    const fromCenter = getTileCenter(from, tiles)\r\n    const toCenter = getTileCenter(to, tiles)\r\n    if (fromCenter && toCenter) {\r\n      ctx.beginPath()\r\n      ctx.moveTo(fromCenter.x, fromCenter.y)\r\n      ctx.lineTo(toCenter.x, toCenter.y)\r\n      ctx.stroke()\r\n    }\r\n  }\r\n\r\n  ctx.setLineDash([])\r\n}\r\n","import type { GameState, Entity, Tile } from '../types/state.ts'\r\nimport { getTileCenter } from './tiles.ts'\r\n\r\ninterface EntityDot {\r\n  x: number\r\n  y: number\r\n  targetX: number\r\n  targetY: number\r\n  type: 'ant' | 'visitor'\r\n  subtype?: string\r\n  adorned?: boolean\r\n  entity: Entity\r\n}\r\n\r\nconst entityDots: Map<string, EntityDot> = new Map()\r\n\r\n// Expose positions for tooltip system\r\nexport function getEntityDots(): Map<string, EntityDot> {\r\n  return entityDots\r\n}\r\n\r\nexport function updateEntityDots(state: GameState): void {\r\n  const tiles = state.map?.tiles\r\n  const entities = state.entities\r\n  if (!tiles || !entities) return\r\n\r\n  // Update or create dots for each entity\r\n  for (const entity of entities) {\r\n    const tileCenter = getTileCenter(entity.tile, tiles)\r\n    if (!tileCenter) continue\r\n\r\n    let dot = entityDots.get(entity.id)\r\n    if (!dot) {\r\n      // Create new dot with random offset within tile\r\n      dot = {\r\n        x: tileCenter.x + (Math.random() - 0.5) * 60,\r\n        y: tileCenter.y + (Math.random() - 0.5) * 60,\r\n        targetX: tileCenter.x + (Math.random() - 0.5) * 60,\r\n        targetY: tileCenter.y + (Math.random() - 0.5) * 60,\r\n        type: entity.type,\r\n        subtype: entity.subtype,\r\n        adorned: entity.adorned,\r\n        entity: entity\r\n      }\r\n      entityDots.set(entity.id, dot)\r\n    }\r\n\r\n    // Slowly drift toward target\r\n    dot.x += (dot.targetX - dot.x) * 0.02\r\n    dot.y += (dot.targetY - dot.y) * 0.02\r\n\r\n    // Pick new target occasionally\r\n    if (Math.random() < 0.01) {\r\n      dot.targetX = tileCenter.x + (Math.random() - 0.5) * 60\r\n      dot.targetY = tileCenter.y + (Math.random() - 0.5) * 60\r\n    }\r\n\r\n    // Update entity properties\r\n    dot.type = entity.type\r\n    dot.subtype = entity.subtype\r\n    dot.adorned = entity.adorned\r\n    dot.entity = entity\r\n  }\r\n\r\n  // Remove dots for dead entities\r\n  const livingIds = new Set(entities.map(e => e.id))\r\n  for (const id of entityDots.keys()) {\r\n    if (!livingIds.has(id)) {\r\n      entityDots.delete(id)\r\n    }\r\n  }\r\n}\r\n\r\nexport function drawEntityDots(ctx: CanvasRenderingContext2D): void {\r\n  for (const [_id, dot] of entityDots) {\r\n    ctx.beginPath()\r\n    const size = dot.adorned ? 5 : 4\r\n\r\n    if (dot.type === 'visitor') {\r\n      // Visitors glow blue (or red if hungry)\r\n      const color = dot.subtype === 'hungry' ? '#f88' : '#8af'\r\n      ctx.arc(dot.x, dot.y, size, 0, Math.PI * 2)\r\n      ctx.fillStyle = color\r\n      ctx.shadowColor = color\r\n      ctx.shadowBlur = 8\r\n    } else if (dot.adorned) {\r\n      // Adorned ants have golden glow\r\n      ctx.arc(dot.x, dot.y, size, 0, Math.PI * 2)\r\n      ctx.fillStyle = '#ca8'\r\n      ctx.shadowColor = '#ca8'\r\n      ctx.shadowBlur = 6\r\n    } else {\r\n      // Regular ants\r\n      ctx.arc(dot.x, dot.y, size - 1, 0, Math.PI * 2)\r\n      ctx.fillStyle = '#a85'\r\n      ctx.shadowBlur = 0\r\n    }\r\n\r\n    ctx.fill()\r\n    ctx.shadowBlur = 0\r\n  }\r\n}\r\n","import type { GameState } from '../types/state.ts'\r\nimport { getTileCenter } from './tiles.ts'\r\n\r\ninterface Spirit {\r\n  id: string\r\n  x: number\r\n  y: number\r\n  baseY: number\r\n  alpha: number\r\n  phase: number\r\n  isVisitor: boolean\r\n}\r\n\r\nconst spirits: Map<string, Spirit> = new Map()\r\n\r\nexport function updateSpirits(state: GameState): void {\r\n  const tiles = state.map?.tiles\r\n  const corpses = state.graveyard?.corpses ?? []\r\n  if (!tiles) return\r\n\r\n  const corpseIds = new Set(corpses.map(c => c.entity_id))\r\n\r\n  // Add new spirits for fresh corpses\r\n  for (const corpse of corpses) {\r\n    if (!spirits.has(corpse.entity_id)) {\r\n      const center = getTileCenter(corpse.tile, tiles)\r\n      if (center) {\r\n        spirits.set(corpse.entity_id, {\r\n          id: corpse.entity_id,\r\n          x: center.x + (Math.random() - 0.5) * 40,\r\n          y: center.y + (Math.random() - 0.5) * 40,\r\n          baseY: center.y + (Math.random() - 0.5) * 40,\r\n          alpha: 0.6,\r\n          phase: Math.random() * Math.PI * 2,\r\n          isVisitor: corpse.entity_type === 'visitor'\r\n        })\r\n      }\r\n    }\r\n  }\r\n\r\n  // Update existing spirits - float upward slowly, fade\r\n  for (const [id, spirit] of spirits) {\r\n    spirit.phase += 0.02\r\n    spirit.y = spirit.baseY + Math.sin(spirit.phase) * 5 - (spirit.phase * 0.3) // Drift upward\r\n    spirit.alpha -= 0.0005 // Slow fade\r\n\r\n    // Remove spirits that have faded or risen too high\r\n    if (spirit.alpha <= 0 || spirit.y < spirit.baseY - 50) {\r\n      spirits.delete(id)\r\n    }\r\n  }\r\n\r\n  // Remove spirits for processed corpses\r\n  for (const id of spirits.keys()) {\r\n    if (!corpseIds.has(id)) {\r\n      // Corpse was processed - accelerate fade\r\n      const spirit = spirits.get(id)\r\n      if (spirit) {\r\n        spirit.alpha -= 0.02\r\n        if (spirit.alpha <= 0) {\r\n          spirits.delete(id)\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function drawSpirits(ctx: CanvasRenderingContext2D): void {\r\n  for (const [_id, spirit] of spirits) {\r\n    ctx.save()\r\n    ctx.globalAlpha = spirit.alpha\r\n\r\n    // Draw a wispy ghost shape\r\n    const gradient = ctx.createRadialGradient(\r\n      spirit.x, spirit.y, 0,\r\n      spirit.x, spirit.y, 12\r\n    )\r\n\r\n    if (spirit.isVisitor) {\r\n      // Visitor spirits are blue-tinged\r\n      gradient.addColorStop(0, 'rgba(150, 180, 255, 0.8)')\r\n      gradient.addColorStop(0.5, 'rgba(100, 130, 200, 0.4)')\r\n      gradient.addColorStop(1, 'rgba(80, 100, 180, 0)')\r\n    } else {\r\n      // Ant spirits are pale amber\r\n      gradient.addColorStop(0, 'rgba(220, 200, 180, 0.8)')\r\n      gradient.addColorStop(0.5, 'rgba(180, 160, 140, 0.4)')\r\n      gradient.addColorStop(1, 'rgba(150, 130, 110, 0)')\r\n    }\r\n\r\n    ctx.fillStyle = gradient\r\n    ctx.beginPath()\r\n    ctx.arc(spirit.x, spirit.y, 12, 0, Math.PI * 2)\r\n    ctx.fill()\r\n\r\n    // Small highlight\r\n    ctx.beginPath()\r\n    ctx.arc(spirit.x - 2, spirit.y - 2, 3, 0, Math.PI * 2)\r\n    ctx.fillStyle = spirit.isVisitor ? 'rgba(200, 220, 255, 0.5)' : 'rgba(255, 250, 240, 0.5)'\r\n    ctx.fill()\r\n\r\n    ctx.restore()\r\n  }\r\n}\r\n","import type { GameState, Entity, Decision } from '../types/state.ts'\r\n\r\nexport function renderTick(state: GameState): void {\r\n  const el = document.getElementById('tick')\r\n  if (el) {\r\n    el.textContent = `tick: ${state.tick}`\r\n  }\r\n}\r\n\r\nexport function renderResources(state: GameState): void {\r\n  const el = document.getElementById('resources')\r\n  if (!el) return\r\n\r\n  const resources = state.resources ?? {}\r\n  if (Object.keys(resources).length === 0) {\r\n    el.innerHTML = '<div class=\"empty\">nothing yet</div>'\r\n    return\r\n  }\r\n\r\n  el.innerHTML = Object.entries(resources)\r\n    .map(([name, value]) => `\r\n      <div class=\"resource\">\r\n        <span class=\"resource-name\">${name}</span>\r\n        <span class=\"resource-value\">${Math.floor(value ?? 0)}</span>\r\n      </div>\r\n    `)\r\n    .join('')\r\n}\r\n\r\nexport function renderEntities(state: GameState): void {\r\n  const el = document.getElementById('entities')\r\n  if (!el) return\r\n\r\n  const entities = state.entities ?? []\r\n  if (entities.length === 0) {\r\n    el.innerHTML = '<div class=\"empty\">no entities</div>'\r\n    return\r\n  }\r\n\r\n  // Group by role\r\n  const byRole: Record<string, number> = {}\r\n  const visitors: Entity[] = []\r\n\r\n  for (const e of entities) {\r\n    if (e.type === 'visitor') {\r\n      visitors.push(e)\r\n    } else {\r\n      const role = e.role ?? e.type ?? 'unknown'\r\n      byRole[role] = (byRole[role] ?? 0) + 1\r\n    }\r\n  }\r\n\r\n  let html = Object.entries(byRole)\r\n    .map(([role, count]) => `\r\n      <div class=\"stat-row\">\r\n        <span class=\"stat-label\">${role}</span>\r\n        <span class=\"stat-value\">${count}</span>\r\n      </div>\r\n    `)\r\n    .join('')\r\n\r\n  // Show visitors separately\r\n  for (const v of visitors) {\r\n    html += `\r\n      <div class=\"stat-row visitor-row\">\r\n        <span class=\"stat-label\">${v.name ?? v.subtype ?? 'visitor'}</span>\r\n        <span class=\"stat-value visitor-subtype\">${v.subtype ?? ''}</span>\r\n      </div>\r\n    `\r\n  }\r\n\r\n  el.innerHTML = html\r\n}\r\n\r\nexport function renderBoredom(state: GameState): void {\r\n  const fill = document.getElementById('boredom-fill')\r\n  if (!fill) return\r\n\r\n  const boredom = state.meta?.boredom ?? 0\r\n  const pct = Math.min(100, (boredom / 60) * 100)\r\n  fill.style.width = `${pct}%`\r\n}\r\n\r\nexport function renderSanity(state: GameState): void {\r\n  const fill = document.getElementById('sanity-fill')\r\n  const value = document.getElementById('sanity-value')\r\n  if (!fill || !value) return\r\n\r\n  const sanity = state.meta?.sanity ?? 100\r\n  fill.style.width = `${sanity}%`\r\n  value.textContent = `${sanity.toFixed(1)}%`\r\n\r\n  // Color based on level\r\n  if (sanity < 30) {\r\n    fill.style.background = '#a44'\r\n  } else if (sanity < 60) {\r\n    fill.style.background = '#a84'\r\n  } else {\r\n    fill.style.background = '#484'\r\n  }\r\n}\r\n\r\nexport function renderContamination(state: GameState): void {\r\n  const fill = document.getElementById('contamination-fill')\r\n  const status = document.getElementById('contamination-status')\r\n  if (!fill || !status) return\r\n\r\n  const compostTile = state.map?.tiles?.compost\r\n  const contamination = compostTile?.contamination ?? 0\r\n\r\n  fill.style.width = `${contamination * 100}%`\r\n\r\n  if (compostTile?.blighted) {\r\n    status.textContent = `BLIGHTED (${compostTile.blight_ticks_remaining}t remaining)`\r\n    status.style.color = '#a55'\r\n  } else if (contamination > 0) {\r\n    status.textContent = `${(contamination * 100).toFixed(1)}% blight chance`\r\n    status.style.color = '#755'\r\n  } else {\r\n    status.textContent = 'clean'\r\n    status.style.color = '#555'\r\n  }\r\n}\r\n\r\nexport function renderSystems(state: GameState): void {\r\n  const el = document.getElementById('systems')\r\n  if (!el) return\r\n\r\n  const systems = state.systems ?? {}\r\n  if (Object.keys(systems).length === 0) {\r\n    el.innerHTML = '<div class=\"empty\">no systems</div>'\r\n    return\r\n  }\r\n\r\n  el.innerHTML = Object.entries(systems)\r\n    .map(([id, system]) => {\r\n      let output = ''\r\n      if (system.generates && Object.keys(system.generates).length > 0) {\r\n        output = Object.entries(system.generates)\r\n          .map(([r, v]) => `+${v}/tick ${r}`)\r\n          .join(', ')\r\n      }\r\n      return `\r\n        <div class=\"system\">\r\n          <div class=\"system-name\">${system.name ?? id}</div>\r\n          <div class=\"system-output\">${output || 'idle'}</div>\r\n        </div>\r\n      `\r\n    })\r\n    .join('')\r\n}\r\n\r\nexport function renderCorpses(state: GameState): void {\r\n  const el = document.getElementById('corpses')\r\n  if (!el) return\r\n\r\n  const graveyard = state.graveyard ?? { corpses: [], total_processed: 0 }\r\n  const corpses = graveyard.corpses ?? []\r\n  const processed = graveyard.total_processed ?? 0\r\n\r\n  if (corpses.length === 0 && processed === 0) {\r\n    el.innerHTML = '<div class=\"empty\">none</div>'\r\n    return\r\n  }\r\n\r\n  el.innerHTML = `\r\n    <div class=\"stat-row\">\r\n      <span class=\"stat-label\">awaiting</span>\r\n      <span class=\"stat-value\">${corpses.length}</span>\r\n    </div>\r\n    <div class=\"stat-row\">\r\n      <span class=\"stat-label\">processed</span>\r\n      <span class=\"stat-value\">${processed}</span>\r\n    </div>\r\n  `\r\n}\r\n\r\nexport function renderRejectedIdeas(state: GameState): void {\r\n  const el = document.getElementById('rejected')\r\n  if (!el) return\r\n\r\n  const rejected = state.meta?.rejected_ideas ?? []\r\n  if (rejected.length === 0) {\r\n    el.innerHTML = '<div class=\"empty\">empty</div>'\r\n    return\r\n  }\r\n\r\n  el.innerHTML = rejected\r\n    .map(idea => `<div class=\"graveyard-item\">${idea}</div>`)\r\n    .join('')\r\n}\r\n\r\nexport function renderEventLog(state: GameState): void {\r\n  const el = document.getElementById('event-log')\r\n  if (!el) return\r\n\r\n  const log = state.meta?.event_log ?? []\r\n  if (log.length === 0) {\r\n    el.innerHTML = '<div class=\"empty\">no events yet</div>'\r\n    return\r\n  }\r\n\r\n  // Show last 10 events, most recent first\r\n  const recent = log.slice(-10).reverse()\r\n\r\n  el.innerHTML = recent\r\n    .map(event => `\r\n      <div class=\"event-entry event-type-${event.type}\">\r\n        <div class=\"event-tick\">t${event.tick}</div>\r\n        <div class=\"event-message\">${event.message}</div>\r\n      </div>\r\n    `)\r\n    .join('')\r\n}\r\n\r\nexport function renderGoals(state: GameState): void {\r\n  const el = document.getElementById('goals')\r\n  if (!el) return\r\n\r\n  const goals = state.meta?.goals ?? {}\r\n  const resources = state.resources ?? {}\r\n\r\n  // Filter to unbuilt goals with progress tracking\r\n  const activeGoals = Object.entries(goals).filter(\r\n    ([_id, goal]) => !goal.built && goal.progress !== undefined\r\n  )\r\n\r\n  if (activeGoals.length === 0) {\r\n    el.innerHTML = '<div class=\"empty\">no active goals</div>'\r\n    return\r\n  }\r\n\r\n  el.innerHTML = activeGoals\r\n    .map(([id, goal]) => {\r\n      const costEntries = Object.entries(goal.cost)\r\n      const progressBars = costEntries.map(([resource, required]) => {\r\n        const current = resources[resource] ?? 0\r\n        const progress = goal.progress?.[resource] ?? 0\r\n        const progressPct = Math.min(100, (progress / required) * 100)\r\n        const canContribute = current > 0 && progress < required\r\n\r\n        return `\r\n          <div class=\"goal-resource\">\r\n            <div class=\"goal-resource-header\">\r\n              <span class=\"goal-resource-name\">${resource}</span>\r\n              <span class=\"goal-resource-count\">${Math.floor(progress)}/${required}</span>\r\n            </div>\r\n            <div class=\"goal-bar\">\r\n              <div class=\"goal-bar-fill ${canContribute ? 'can-contribute' : ''}\" style=\"width: ${progressPct}%\"></div>\r\n            </div>\r\n          </div>\r\n        `\r\n      }).join('')\r\n\r\n      const totalProgress = costEntries.reduce((sum, [resource, required]) => {\r\n        const progress = goal.progress?.[resource] ?? 0\r\n        return sum + (progress / required)\r\n      }, 0) / costEntries.length * 100\r\n\r\n      return `\r\n        <div class=\"goal-card\">\r\n          <div class=\"goal-header\">\r\n            <span class=\"goal-name\">${goal.name}</span>\r\n            <span class=\"goal-pct\">${totalProgress.toFixed(0)}%</span>\r\n          </div>\r\n          <div class=\"goal-desc\">${goal.description}</div>\r\n          <div class=\"goal-resources\">\r\n            ${progressBars}\r\n          </div>\r\n        </div>\r\n      `\r\n    })\r\n    .join('')\r\n}\r\n\r\nexport function renderDecisions(decisions: Decision[]): void {\r\n  const el = document.getElementById('decisions')\r\n  if (!el) return\r\n\r\n  if (decisions.length === 0) {\r\n    el.innerHTML = '<div class=\"empty\">no decisions logged</div>'\r\n    return\r\n  }\r\n\r\n  // Show most recent first\r\n  const recent = [...decisions].reverse()\r\n\r\n  el.innerHTML = recent\r\n    .map(d => `\r\n      <div class=\"decision-entry\">\r\n        <div class=\"decision-tick\">t${d.tick}<span class=\"decision-type\">${d.type}</span></div>\r\n        <div class=\"decision-choice\">${d.choice}</div>\r\n        ${d.why ? `<div class=\"decision-why\">${d.why}</div>` : ''}\r\n      </div>\r\n    `)\r\n    .join('')\r\n}\r\n\r\nexport function renderAll(state: GameState): void {\r\n  renderTick(state)\r\n  renderResources(state)\r\n  renderEntities(state)\r\n  renderBoredom(state)\r\n  renderSanity(state)\r\n  renderContamination(state)\r\n  renderSystems(state)\r\n  renderCorpses(state)\r\n  renderRejectedIdeas(state)\r\n  renderEventLog(state)\r\n  renderGoals(state)\r\n}\r\n","import type { Entity } from '../types/state.ts'\r\n\r\ninterface EntityDot {\r\n  x: number\r\n  y: number\r\n  entity: Entity\r\n}\r\n\r\nlet tooltipEl: HTMLDivElement | null = null\r\n\r\nexport function initTooltip(): void {\r\n  tooltipEl = document.createElement('div')\r\n  tooltipEl.className = 'entity-tooltip'\r\n  tooltipEl.style.display = 'none'\r\n  document.body.appendChild(tooltipEl)\r\n}\r\n\r\nfunction findNearestEntity(\r\n  mouseX: number,\r\n  mouseY: number,\r\n  entityDots: Map<string, EntityDot>,\r\n  radius: number = 20\r\n): Entity | null {\r\n  let nearestEntity: Entity | null = null\r\n  let nearestDist = radius\r\n\r\n  for (const [_id, dot] of entityDots) {\r\n    const dx = dot.x - mouseX\r\n    const dy = dot.y - mouseY\r\n    const dist = Math.sqrt(dx * dx + dy * dy)\r\n    if (dist < nearestDist) {\r\n      nearestDist = dist\r\n      nearestEntity = dot.entity\r\n    }\r\n  }\r\n\r\n  return nearestEntity\r\n}\r\n\r\nexport function handleTooltipHover(\r\n  e: MouseEvent,\r\n  mapContainer: HTMLElement,\r\n  entityDots: Map<string, EntityDot>\r\n): void {\r\n  if (!tooltipEl) return\r\n\r\n  const rect = mapContainer.getBoundingClientRect()\r\n  const mouseX = e.clientX - rect.left\r\n  const mouseY = e.clientY - rect.top\r\n\r\n  const nearestEntity = findNearestEntity(mouseX, mouseY, entityDots)\r\n\r\n  if (nearestEntity) {\r\n    showTooltip(nearestEntity, e.clientX, e.clientY)\r\n  } else {\r\n    hideTooltip()\r\n  }\r\n}\r\n\r\nexport function handleEntityClick(\r\n  e: MouseEvent,\r\n  mapContainer: HTMLElement,\r\n  entityDots: Map<string, EntityDot>\r\n): Entity | null {\r\n  const rect = mapContainer.getBoundingClientRect()\r\n  const mouseX = e.clientX - rect.left\r\n  const mouseY = e.clientY - rect.top\r\n\r\n  return findNearestEntity(mouseX, mouseY, entityDots)\r\n}\r\n\r\nfunction showTooltip(entity: Entity, x: number, y: number): void {\r\n  if (!tooltipEl) return\r\n\r\n  const agePercent = ((entity.age / entity.max_age) * 100).toFixed(1)\r\n  const hungerPercent = entity.hunger.toFixed(1)\r\n\r\n  let content = `<div class=\"tooltip-header\">`\r\n  if (entity.type === 'visitor') {\r\n    content += `<span class=\"tooltip-type visitor\">${entity.name || entity.subtype || 'visitor'}</span>`\r\n  } else {\r\n    content += `<span class=\"tooltip-type\">${entity.role || 'ant'}</span>`\r\n    if (entity.adorned) {\r\n      content += `<span class=\"tooltip-adorned\">‚òÖ</span>`\r\n    }\r\n  }\r\n  content += `</div>`\r\n\r\n  content += `<div class=\"tooltip-stats\">`\r\n  content += `<div class=\"tooltip-row\"><span>age:</span><span>${agePercent}%</span></div>`\r\n  content += `<div class=\"tooltip-row\"><span>hunger:</span><span>${hungerPercent}</span></div>`\r\n  content += `<div class=\"tooltip-row\"><span>tile:</span><span>${entity.tile}</span></div>`\r\n\r\n  if (entity.type === 'visitor' && entity.description) {\r\n    content += `<div class=\"tooltip-desc\">${entity.description}</div>`\r\n  }\r\n\r\n  if (entity.processing_corpse) {\r\n    content += `<div class=\"tooltip-activity\">processing corpse...</div>`\r\n  }\r\n\r\n  content += `</div>`\r\n\r\n  tooltipEl.innerHTML = content\r\n  tooltipEl.style.display = 'block'\r\n  tooltipEl.style.left = `${x + 15}px`\r\n  tooltipEl.style.top = `${y + 15}px`\r\n}\r\n\r\nfunction hideTooltip(): void {\r\n  if (tooltipEl) {\r\n    tooltipEl.style.display = 'none'\r\n  }\r\n}\r\n","import type { GameState, Tile, System, Entity } from '../types/state.ts'\r\nimport { getStalledFlows } from '../renderer/particles.ts'\r\n\r\nlet modalEl: HTMLDivElement | null = null\r\nlet backdropEl: HTMLDivElement | null = null\r\n\r\nexport function initModal(): void {\r\n  // Create backdrop\r\n  backdropEl = document.createElement('div')\r\n  backdropEl.className = 'modal-backdrop'\r\n  backdropEl.style.display = 'none'\r\n  backdropEl.addEventListener('click', hideModal)\r\n  document.body.appendChild(backdropEl)\r\n\r\n  // Create modal container\r\n  modalEl = document.createElement('div')\r\n  modalEl.className = 'modal'\r\n  modalEl.style.display = 'none'\r\n  modalEl.addEventListener('click', (e) => e.stopPropagation())\r\n  document.body.appendChild(modalEl)\r\n}\r\n\r\nexport function hideModal(): void {\r\n  if (modalEl) modalEl.style.display = 'none'\r\n  if (backdropEl) backdropEl.style.display = 'none'\r\n}\r\n\r\nfunction showModal(content: string, title: string): void {\r\n  if (!modalEl || !backdropEl) return\r\n\r\n  modalEl.innerHTML = `\r\n    <div class=\"modal-header\">\r\n      <span class=\"modal-title\">${title}</span>\r\n      <button class=\"modal-close\">&times;</button>\r\n    </div>\r\n    <div class=\"modal-body\">\r\n      ${content}\r\n    </div>\r\n  `\r\n\r\n  const closeBtn = modalEl.querySelector('.modal-close')\r\n  closeBtn?.addEventListener('click', hideModal)\r\n\r\n  backdropEl.style.display = 'block'\r\n  modalEl.style.display = 'block'\r\n}\r\n\r\nexport function showTileModal(tileId: string, tile: Tile, state: GameState): void {\r\n  const system = state.systems?.[tileId]\r\n  const entities = state.entities?.filter(e => e.tile === tileId) ?? []\r\n  const connections = state.map?.connections ?? []\r\n  const stalledFlows = getStalledFlows()\r\n\r\n  // Find connected tiles\r\n  const connectedTiles: string[] = []\r\n  for (const [a, b] of connections) {\r\n    if (a === tileId) connectedTiles.push(b)\r\n    if (b === tileId) connectedTiles.push(a)\r\n  }\r\n\r\n  let content = `<div class=\"modal-section\">`\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Type:</span><span>${tile.type}</span></div>`\r\n  if (tile.description) {\r\n    content += `<div class=\"modal-desc\">${tile.description}</div>`\r\n  }\r\n  if (tile.resource) {\r\n    content += `<div class=\"modal-row\"><span class=\"modal-label\">Resource:</span><span>${tile.resource}</span></div>`\r\n  }\r\n  content += `</div>`\r\n\r\n  // Contamination/blight status\r\n  if (tile.contamination !== undefined || tile.blighted) {\r\n    content += `<div class=\"modal-section\">`\r\n    content += `<h3>Status</h3>`\r\n    if (tile.blighted) {\r\n      content += `<div class=\"modal-warning\">BLIGHTED - ${tile.blight_ticks_remaining} ticks remaining</div>`\r\n    } else if (tile.contamination && tile.contamination > 0) {\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Contamination:</span><span>${(tile.contamination * 100).toFixed(1)}%</span></div>`\r\n    } else {\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Contamination:</span><span>clean</span></div>`\r\n    }\r\n    content += `</div>`\r\n  }\r\n\r\n  // System information\r\n  if (system) {\r\n    content += `<div class=\"modal-section\">`\r\n    content += `<h3>System: ${system.name}</h3>`\r\n    if (system.description) {\r\n      content += `<div class=\"modal-desc\">${system.description}</div>`\r\n    }\r\n\r\n    if (system.generates && Object.keys(system.generates).length > 0) {\r\n      content += `<div class=\"modal-subsection\"><strong>Produces:</strong></div>`\r\n      for (const [resource, rate] of Object.entries(system.generates)) {\r\n        content += `<div class=\"modal-row\"><span class=\"modal-label\">${resource}</span><span class=\"modal-value-good\">+${rate}/tick</span></div>`\r\n      }\r\n    }\r\n\r\n    if (system.consumes && Object.keys(system.consumes).length > 0) {\r\n      content += `<div class=\"modal-subsection\"><strong>Consumes:</strong></div>`\r\n      for (const [resource, rate] of Object.entries(system.consumes)) {\r\n        const isStalled = stalledFlows.has(`${tileId}:${resource}`)\r\n        const stalledClass = isStalled ? 'modal-value-warning' : ''\r\n        content += `<div class=\"modal-row\"><span class=\"modal-label\">${resource}</span><span class=\"modal-value-bad ${stalledClass}\">-${rate}/tick${isStalled ? ' (LOW)' : ''}</span></div>`\r\n      }\r\n    }\r\n\r\n    if (system.sanity_efficiency !== undefined) {\r\n      const pct = (system.sanity_efficiency * 100).toFixed(1)\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Sanity efficiency:</span><span>${pct}%</span></div>`\r\n    }\r\n\r\n    content += `</div>`\r\n  }\r\n\r\n  // Connected tiles\r\n  if (connectedTiles.length > 0) {\r\n    content += `<div class=\"modal-section\">`\r\n    content += `<h3>Connections</h3>`\r\n    content += `<div class=\"modal-tags\">`\r\n    for (const id of connectedTiles) {\r\n      const connTile = state.map?.tiles?.[id]\r\n      content += `<span class=\"modal-tag\">${connTile?.name ?? id}</span>`\r\n    }\r\n    content += `</div></div>`\r\n  }\r\n\r\n  // Entities present\r\n  if (entities.length > 0) {\r\n    content += `<div class=\"modal-section\">`\r\n    content += `<h3>Entities Here (${entities.length})</h3>`\r\n    for (const entity of entities) {\r\n      const agePercent = ((entity.age / entity.max_age) * 100).toFixed(0)\r\n      const icon = entity.type === 'visitor' ? 'üëÅ' : entity.adorned ? '‚òÖ' : '‚Ä¢'\r\n      const label = entity.type === 'visitor'\r\n        ? (entity.name ?? entity.subtype ?? 'visitor')\r\n        : (entity.role ?? 'ant')\r\n      content += `<div class=\"modal-entity\">`\r\n      content += `<span class=\"modal-entity-icon\">${icon}</span>`\r\n      content += `<span class=\"modal-entity-name\">${label}</span>`\r\n      content += `<span class=\"modal-entity-stat\">age ${agePercent}%</span>`\r\n      content += `<span class=\"modal-entity-stat\">hunger ${entity.hunger.toFixed(0)}</span>`\r\n      content += `</div>`\r\n    }\r\n    content += `</div>`\r\n  }\r\n\r\n  showModal(content, tile.name)\r\n}\r\n\r\nexport function showEntityModal(entity: Entity, state: GameState): void {\r\n  const tile = state.map?.tiles?.[entity.tile]\r\n  const jewelry = state.meta?.jewelry?.find(j => j.worn_by === entity.id)\r\n\r\n  let content = `<div class=\"modal-section\">`\r\n\r\n  // Basic info\r\n  const entityType = entity.type === 'visitor'\r\n    ? (entity.subtype ?? 'visitor')\r\n    : (entity.role ?? 'ant')\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Type:</span><span>${entityType}</span></div>`\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">ID:</span><span class=\"modal-id\">${entity.id}</span></div>`\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Location:</span><span>${tile?.name ?? entity.tile}</span></div>`\r\n\r\n  if (entity.description) {\r\n    content += `<div class=\"modal-desc\">${entity.description}</div>`\r\n  }\r\n  content += `</div>`\r\n\r\n  // Vital stats\r\n  content += `<div class=\"modal-section\">`\r\n  content += `<h3>Vitals</h3>`\r\n\r\n  const agePercent = (entity.age / entity.max_age) * 100\r\n  const ageColor = agePercent > 80 ? 'modal-value-warning' : ''\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Age:</span><span class=\"${ageColor}\">${entity.age} / ${entity.max_age} ticks (${agePercent.toFixed(1)}%)</span></div>`\r\n\r\n  const hungerColor = entity.hunger < 30 ? 'modal-value-warning' : ''\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Hunger:</span><span class=\"${hungerColor}\">${entity.hunger.toFixed(1)}</span></div>`\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Hunger rate:</span><span>-${entity.hunger_rate}/tick</span></div>`\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Food:</span><span>${entity.food}</span></div>`\r\n\r\n  // Time until death estimates\r\n  const ticksUntilStarvation = entity.hunger / entity.hunger_rate\r\n  const ticksUntilOldAge = entity.max_age - entity.age\r\n  const ticksUntilDeath = Math.min(ticksUntilStarvation, ticksUntilOldAge)\r\n  const deathCause = ticksUntilStarvation < ticksUntilOldAge ? 'starvation' : 'old age'\r\n  content += `<div class=\"modal-row\"><span class=\"modal-label\">Est. lifespan:</span><span>~${Math.floor(ticksUntilDeath)} ticks (${deathCause})</span></div>`\r\n\r\n  content += `</div>`\r\n\r\n  // Special attributes\r\n  if (entity.adorned || jewelry || entity.processing_corpse || entity.generates) {\r\n    content += `<div class=\"modal-section\">`\r\n    content += `<h3>Special</h3>`\r\n\r\n    if (entity.adorned && jewelry) {\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Wearing:</span><span class=\"modal-value-special\">${jewelry.name}</span></div>`\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Adorned at:</span><span>tick ${jewelry.worn_tick}</span></div>`\r\n    }\r\n\r\n    if (entity.processing_corpse) {\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Activity:</span><span>Processing corpse (${entity.processing_ticks} ticks)</span></div>`\r\n    }\r\n\r\n    if (entity.previous_role) {\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Previous role:</span><span>${entity.previous_role}</span></div>`\r\n    }\r\n\r\n    if (entity.generates) {\r\n      content += `<div class=\"modal-subsection\"><strong>Generates:</strong></div>`\r\n      for (const [resource, rate] of Object.entries(entity.generates)) {\r\n        content += `<div class=\"modal-row\"><span class=\"modal-label\">${resource}</span><span class=\"modal-value-good\">+${rate}/tick</span></div>`\r\n      }\r\n    }\r\n\r\n    if (entity.influence_rate) {\r\n      content += `<div class=\"modal-row\"><span class=\"modal-label\">Influence rate:</span><span>${entity.influence_rate}/tick</span></div>`\r\n    }\r\n\r\n    content += `</div>`\r\n  }\r\n\r\n  // Visitor specific\r\n  if (entity.type === 'visitor' && entity.from_outside) {\r\n    content += `<div class=\"modal-section\">`\r\n    content += `<div class=\"modal-note\">This entity came from the Outside.</div>`\r\n    content += `</div>`\r\n  }\r\n\r\n  const title = entity.name ?? (entity.adorned ? `‚òÖ ${entityType}` : entityType)\r\n  showModal(content, title)\r\n}\r\n","import { SSEClient, fetchInitialState } from './sse/client.ts'\r\nimport { setupCanvas, clearCanvas } from './renderer/canvas.ts'\r\nimport { renderTiles, drawConnections, setTileClickHandler } from './renderer/tiles.ts'\r\nimport { updateEntityDots, drawEntityDots, getEntityDots } from './renderer/entities.ts'\r\nimport { updateParticles, spawnResourceParticles, drawParticles } from './renderer/particles.ts'\r\nimport { updateSpirits, drawSpirits } from './renderer/spirits.ts'\r\nimport { renderAll, renderDecisions } from './ui/panels.ts'\r\nimport { initTooltip, handleTooltipHover, handleEntityClick } from './ui/tooltip.ts'\r\nimport { initModal, showTileModal, showEntityModal } from './ui/modal.ts'\r\nimport type { GameState, Decision } from './types/state.ts'\r\n\r\nlet currentState: GameState | null = null\r\nlet lastDecisionsFetch = 0\r\n\r\nfunction main() {\r\n  const mapContainer = document.getElementById('map')\r\n  if (!mapContainer) {\r\n    console.error('Map container not found')\r\n    return\r\n  }\r\n\r\n  const container = mapContainer // Capture for closure\r\n  const canvasContext = setupCanvas(container)\r\n  const client = new SSEClient('/events')\r\n\r\n  // Initialize UI systems\r\n  initTooltip()\r\n  initModal()\r\n\r\n  // Set up tile click handler\r\n  setTileClickHandler((tileId, tile) => {\r\n    if (currentState) {\r\n      showTileModal(tileId, tile, currentState)\r\n    }\r\n  })\r\n\r\n  // Handle mouse events on canvas for entity interaction\r\n  container.addEventListener('mousemove', (e) => {\r\n    const entityDots = getEntityDots()\r\n    handleTooltipHover(e, container, entityDots)\r\n  })\r\n\r\n  // Entity click handler\r\n  container.addEventListener('click', (e) => {\r\n    const entityDots = getEntityDots()\r\n    const entity = handleEntityClick(e, container, entityDots)\r\n    if (entity && currentState) {\r\n      showEntityModal(entity, currentState)\r\n    }\r\n  })\r\n\r\n  // Handle state updates\r\n  function handleState(state: GameState) {\r\n    currentState = state\r\n    renderAll(state)\r\n    renderTiles(container, state)\r\n  }\r\n\r\n  // Animation loop\r\n  function animate() {\r\n    if (currentState) {\r\n      clearCanvas(canvasContext)\r\n\r\n      // Draw connections behind everything\r\n      drawConnections(canvasContext.ctx, currentState)\r\n\r\n      // Update and draw spirits (corpse ghosts)\r\n      updateSpirits(currentState)\r\n      drawSpirits(canvasContext.ctx)\r\n\r\n      // Update and draw entities\r\n      updateEntityDots(currentState)\r\n      drawEntityDots(canvasContext.ctx)\r\n\r\n      // Spawn and draw particles\r\n      spawnResourceParticles(currentState)\r\n      updateParticles()\r\n      drawParticles(canvasContext.ctx)\r\n    }\r\n\r\n    requestAnimationFrame(animate)\r\n  }\r\n\r\n  // Start\r\n  client.onState(handleState)\r\n  client.connect()\r\n  animate()\r\n\r\n  // Load initial state\r\n  fetchInitialState().then(state => {\r\n    if (state) handleState(state)\r\n  })\r\n\r\n  // Fetch decisions periodically (every 10 seconds)\r\n  async function fetchDecisions() {\r\n    try {\r\n      const response = await fetch('/decisions')\r\n      if (response.ok) {\r\n        const decisions: Decision[] = await response.json()\r\n        renderDecisions(decisions)\r\n      }\r\n    } catch (e) {\r\n      console.error('Failed to fetch decisions:', e)\r\n    }\r\n  }\r\n\r\n  // Initial fetch and periodic refresh\r\n  fetchDecisions()\r\n  setInterval(fetchDecisions, 10000)\r\n}\r\n\r\n// Wait for DOM\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', main)\r\n} else {\r\n  main()\r\n}\r\n"],"names":["SSEClient","url","__publicField","event","state","handler","e","fetchInitialState","setupCanvas","container","canvas","ctx","resize","clearCanvas","context","RESOURCE_COLORS","getResourceColor","resource","particles","stalledFlows","getStalledFlows","spawnParticle","from","to","stalled","updateParticles","i","p","findSystemTile","systemId","tiles","withTileSuffix","tileId","findConnectedTile","fromTileId","connections","preferOrigin","connected","a","b","spawnResourceParticles","_a","systems","_b","resources","system","sourceTileId","sourcePos","getTileCenter","rate","spawnChance","destTileId","destPos","isStalled","srcTileId","srcPos","_c","receiverPos","originPos","drawParticles","size","pulse","TILE_SIZE","TILE_GAP","OFFSET_X","OFFSET_Y","currentClickHandler","setTileClickHandler","getTilePosition","tile","x","y","pos","renderTiles","existing","tilesContainer","entities","tilesWithBottlenecks","flowKey","withSuffix","id","div","antsHere","visitorsHere","entityInfo","drawConnections","fromCenter","toCenter","entityDots","getEntityDots","updateEntityDots","entity","tileCenter","dot","livingIds","drawEntityDots","_id","color","spirits","updateSpirits","corpses","corpseIds","c","corpse","center","spirit","drawSpirits","gradient","renderTick","el","renderResources","name","value","renderEntities","byRole","visitors","role","html","count","v","renderBoredom","fill","boredom","pct","renderSanity","sanity","renderContamination","status","compostTile","contamination","renderSystems","output","r","renderCorpses","graveyard","processed","renderRejectedIdeas","rejected","idea","renderEventLog","log","recent","renderGoals","goals","activeGoals","goal","costEntries","progressBars","required","current","progress","progressPct","canContribute","totalProgress","sum","renderDecisions","decisions","d","renderAll","tooltipEl","initTooltip","findNearestEntity","mouseX","mouseY","radius","nearestEntity","nearestDist","dx","dy","dist","handleTooltipHover","mapContainer","rect","showTooltip","hideTooltip","handleEntityClick","agePercent","hungerPercent","content","modalEl","backdropEl","initModal","hideModal","showModal","title","closeBtn","showTileModal","connectedTiles","connTile","_e","_d","icon","label","showEntityModal","jewelry","j","entityType","ageColor","hungerColor","ticksUntilStarvation","ticksUntilOldAge","ticksUntilDeath","deathCause","currentState","main","canvasContext","client","handleState","animate","fetchDecisions","response"],"mappings":"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"}